<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Registration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: white;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 16px;
        }
        
        .department-options {
            display: none;
            margin-top: 10px;
        }
        
        .active {
            display: block;
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: block;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .radio-option input {
            width: auto;
        }
        
        #qrCodeContainer {
            display: none;
            margin-top: 30px;
            text-align: center;
        }
        
        #qrCode {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .payment-message {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 500;
        }
        
        .success-container {
            display: none;
            text-align: center;
            color: white;
        }
        
        .success-container h2 {
            margin-bottom: 15px;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Event Registration</h1>
        
        <div id="registrationForm">
            <div class="form-group">
                <label for="name">Name</label>
                <input type="text" id="name" placeholder="Enter your full name" required>
            </div>
            
            <div class="form-group">
                <label for="email">Email ID</label>
                <input type="email" id="email" placeholder="Enter your email address" required>
            </div>
            
            <div class="form-group">
                <label for="phone">Phone Number</label>
                <input type="tel" id="phone" placeholder="Enter your phone number" required>
            </div>
            
            <div class="form-group">
                <label for="whatsapp">WhatsApp Number</label>
                <input type="tel" id="whatsapp" placeholder="Enter your WhatsApp number" required>
            </div>
            
            <div class="form-group">
                <label for="college">Name of the College</label>
                <input type="text" id="college" placeholder="Enter your college name" required>
            </div>
            
            <div class="form-group">
                <label for="year">Year of Study</label>
                <select id="year" required>
                    <option value="">Select your year</option>
                    <option value="1">1st Year</option>
                    <option value="2">2nd Year</option>
                    <option value="3">3rd Year</option>
                    <option value="4">4th Year</option>
                    <option value="5">5th Year</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="department">Department</label>
                <select id="department" required>
                    <option value="">Select your department</option>
                    <option value="civil">Civil Engineering</option>
                    <option value="cse">Computer Science and Engineering</option>
                    <option value="ece">Electronics and Communication Engineering</option>
                    <option value="eee">Electrical and Electronics Engineering</option>
                    <option value="it">Information Technology</option>
                    <option value="mech">Mechanical Engineering</option>
                    <option value="sh">Science & Humanities</option>
                </select>
            </div>
            
            <!-- Department specific options -->
            <div id="civil-options" class="department-options">
                <div class="form-group">
                    <label for="civil-project">Civil Engineering Project/Paper</label>
                    <input type="text" id="civil-project" placeholder="Paste your Google Drive link here">
                </div>
            </div>
            
            <div id="cse-options" class="department-options">
                <div class="form-group">
                    <label for="cse-project">CSE Project/Paper</label>
                    <input type="text" id="cse-project" placeholder="Paste your Google Drive link here">
                </div>
            </div>
            
            <div id="ece-options" class="department-options">
                <div class="form-group">
                    <label for="ece-project">ECE Project/Paper</label>
                    <input type="text" id="ece-project" placeholder="Paste your Google Drive link here">
                </div>
            </div>
            
            <div id="eee-options" class="department-options">
                <div class="form-group">
                    <label for="eee-project">EEE Project/Paper</label>
                    <input type="text" id="eee-project" placeholder="Paste your Google Drive link here">
                </div>
            </div>
            
            <div id="it-options" class="department-options">
                <div class="form-group">
                    <label for="it-project">IT Project/Paper</label>
                    <input type="text" id="it-project" placeholder="Paste your Google Drive link here">
                </div>
            </div>
            
            <div id="mech-options" class="department-options">
                <div class="form-group">
                    <label for="mech-project">Mechanical Engineering Project/Paper</label>
                    <input type="text" id="mech-project" placeholder="Paste your Google Drive link here">
                </div>
            </div>
            
            <div id="sh-options" class="department-options">
                <div class="form-group">
                    <label for="sh-project">Science & Humanities Project/Paper</label>
                    <input type="text" id="sh-project" placeholder="Paste your Google Drive link here">
                </div>
            </div>
            
            <div class="form-group">
                <label>Mode of Payment</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="online" name="paymentMode" value="online">
                        <label for="online">Online (Razorpay)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="offline" name="paymentMode" value="offline">
                        <label for="offline">Offline (Pay at Venue)</label>
                    </div>
                </div>
            </div>
            
            <button type="button" id="submitBtn">Register Now</button>
        </div>
        
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p style="color: white; margin-top: 10px;">Processing your registration...</p>
        </div>
        
        <div id="qrCodeContainer">
            <h2 style="color: white; margin-bottom: 15px;">Registration Successful!</h2>
            <div id="qrCode"></div>
            <p id="registrationId" style="color: white; margin-top: 10px; font-weight: bold;"></p>
            <div id="offlinePaymentMessage" class="payment-message">
                Please show this QR code at the venue to complete your payment.
                An email with your registration details has been sent to your email address.
            </div>
        </div>
        
        <div class="success-container" id="onlineSuccessContainer">
            <h2>Registration & Payment Successful!</h2>
            <p>Thank you for registering and completing your payment.</p>
            <p>An email with your registration details and payment receipt has been sent to your email address.</p>
            <div id="onlineQrCode" style="width: 200px; height: 200px; margin: 20px auto; background: white; padding: 10px; border-radius: 8px;"></div>
            <p id="onlineRegistrationId" style="margin-top: 10px; font-weight: bold;"></p>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show department-specific options
            const departmentSelect = document.getElementById('department');
            departmentSelect.addEventListener('change', function() {
                // Hide all department options first
                document.querySelectorAll('.department-options').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Show selected department options
                const selectedDept = departmentSelect.value;
                if (selectedDept) {
                    document.getElementById(`${selectedDept}-options`).classList.add('active');
                }
            });
            
            // Handle form submission
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.addEventListener('click', async function() {
                if (!validateForm()) {
                    return;
                }
                
                const loadingSpinner = document.getElementById('loadingSpinner');
                loadingSpinner.style.display = 'block';
                document.getElementById('registrationForm').style.display = 'none';
                
                // Get selected payment mode
                const paymentMode = document.querySelector('input[name="paymentMode"]:checked').value;
                
                // Get form data
                const userData = collectFormData();
                
                try {
                    // Save registration data to MongoDB
                    const registrationResponse = await saveRegistration(userData);
                    
                    if (registrationResponse.success) {
                        const registrationId = registrationResponse.registrationId;
                        
                        // Send confirmation email
                        await sendEmail(userData, registrationId, paymentMode);
                        
                        if (paymentMode === 'online') {
                            // Initiate Razorpay payment
                            initiateRazorpayPayment(registrationId, userData.email, userData.phone);
                        } else {
                            // Show QR code for offline payment
                            loadingSpinner.style.display = 'none';
                            showOfflinePaymentQR(registrationId);
                        }
                    } else {
                        alert('Registration failed. Please try again.');
                        loadingSpinner.style.display = 'none';
                        document.getElementById('registrationForm').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error during registration process:', error);
                    alert('An error occurred during registration. Please try again.');
                    loadingSpinner.style.display = 'none';
                    document.getElementById('registrationForm').style.display = 'block';
                }
            });
        });
        
        function validateForm() {
            // Basic form validation
            const requiredFields = ['name', 'email', 'phone', 'whatsapp', 'college', 'year', 'department'];
            
            for (const field of requiredFields) {
                const element = document.getElementById(field);
                if (!element.value.trim()) {
                    alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.`);
                    element.focus();
                    return false;
                }
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(document.getElementById('email').value)) {
                alert('Please enter a valid email address.');
                document.getElementById('email').focus();
                return false;
            }
            
            // Phone validation
            const phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(document.getElementById('phone').value)) {
                alert('Please enter a valid 10-digit phone number.');
                document.getElementById('phone').focus();
                return false;
            }
            
            // WhatsApp validation
            if (!phoneRegex.test(document.getElementById('whatsapp').value)) {
                alert('Please enter a valid 10-digit WhatsApp number.');
                document.getElementById('whatsapp').focus();
                return false;
            }
            
            // Check if payment mode is selected
            if (!document.querySelector('input[name="paymentMode"]:checked')) {
                alert('Please select a payment mode.');
                return false;
            }
            
            // Validate department specific fields
            const selectedDept = document.getElementById('department').value;
            if (selectedDept) {
                const projectField = document.getElementById(`${selectedDept}-project`);
                if (projectField && !projectField.value.trim()) {
                    alert('Please paste your Google Drive link for your project/paper.');
                    projectField.focus();
                    return false;
                }
                
                // Basic validation for Google Drive link
                if (projectField && !projectField.value.includes('drive.google.com')) {
                    alert('Please enter a valid Google Drive link.');
                    projectField.focus();
                    return false;
                }
            }
            
            return true;
        }
        
        function collectFormData() {
            const selectedDept = document.getElementById('department').value;
            let projectLink = '';
            
            if (selectedDept) {
                projectLink = document.getElementById(`${selectedDept}-project`).value;
            }
            
            return {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                whatsapp: document.getElementById('whatsapp').value,
                college: document.getElementById('college').value,
                year: document.getElementById('year').value,
                department: selectedDept,
                departmentName: document.getElementById('department').options[document.getElementById('department').selectedIndex].text,
                projectLink: projectLink,
                paymentMode: document.querySelector('input[name="paymentMode"]:checked').value,
                paymentStatus: document.querySelector('input[name="paymentMode"]:checked').value === 'offline' ? 'Pending' : 'Initiated',
                registrationDate: new Date().toISOString()
            };
        }
        
        async function saveRegistration(userData) {
            // In a real implementation, you would call your backend API here
            // For demo purposes, we'll simulate a successful registration
            return {
                success: true,
                registrationId: 'REG' + Math.floor(100000 + Math.random() * 900000)
            };
            
            // Real implementation would look like:
            /*
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData),
            });
            
            return await response.json();
            */
        }
        
        async function sendEmail(userData, registrationId, paymentMode) {
            // In a real implementation, you would call your backend API to send email
            // For demo purposes, we'll simulate a successful email sending
            console.log(`Email sent to ${userData.email} with registration ID: ${registrationId}`);
            return { success: true };
            
            // Real implementation would look like:
            /*
            const response = await fetch('/api/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userData,
                    registrationId,
                    paymentMode
                }),
            });
            
            return await response.json();
            */
        }
        
        function initiateRazorpayPayment(registrationId, email, phone) {
            // Event registration fee (in paise - 500 INR)
            const amount = 50000;
            
            const options = {
                key: 'rzp_test_YOUR_KEY_HERE', // Replace with your Razorpay Key ID
                amount: amount,
                currency: 'INR',
                name: 'Event Registration',
                description: 'Registration Fee',
                order_id: 'order_' + Math.random().toString(36).substring(2, 15), // In real implementation, this would come from your backend
                prefill: {
                    email: email,
                    contact: phone
                },
                handler: function(response) {
                    // Payment successful
                    handleSuccessfulPayment(registrationId, response.razorpay_payment_id);
                },
                modal: {
                    ondismiss: function() {
                        // Handle payment modal dismissed
                        document.getElementById('loadingSpinner').style.display = 'none';
                        document.getElementById('registrationForm').style.display = 'block';
                        alert('Payment canceled. You can complete your payment at the venue.');
                    }
                }
            };
            
            const razorpayInstance = new Razorpay(options);
            razorpayInstance.open();
        }
        
        async function handleSuccessfulPayment(registrationId, paymentId) {
            try {
                // In a real implementation, you would verify and update payment status in your database
                // For demo purposes, we'll simulate a successful payment verification
                
                // Update payment status
                /* 
                await fetch('/api/update-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        registrationId: registrationId,
                        paymentId: paymentId,
                        status: 'Completed'
                    }),
                });
                */
                
                // Send payment confirmation email
                /*
                await fetch('/api/send-payment-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        registrationId: registrationId,
                        paymentId: paymentId
                    }),
                });
                */
                
                // Show success message and QR code
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('onlineSuccessContainer').style.display = 'block';
                document.getElementById('onlineRegistrationId').textContent = `Registration ID: ${registrationId}`;
                
                // Generate QR code
                generateQRCode('onlineQrCode', JSON.stringify({
                    registrationId: registrationId,
                    paymentId: paymentId,
                    status: 'Paid'
                }));
                
            } catch (error) {
                console.error('Error processing payment:', error);
                alert('An error occurred while processing your payment. Please contact support.');
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('registrationForm').style.display = 'block';
            }
        }
        
        function showOfflinePaymentQR(registrationId) {
            document.getElementById('qrCodeContainer').style.display = 'block';
            document.getElementById('registrationId').textContent = `Registration ID: ${registrationId}`;
            
            // Generate QR code
            generateQRCode('qrCode', JSON.stringify({
                registrationId: registrationId,
                status: 'Pending Payment'
            }));
        }
        
        function generateQRCode(elementId, data) {
            const typeNumber = 4;
            const errorCorrectionLevel = 'L';
            const qr = qrcode(typeNumber, errorCorrectionLevel);
            qr.addData(data);
            qr.make();
            
            document.getElementById(elementId).innerHTML = qr.createImgTag(5);
        }
    </script>
</body>
</html>